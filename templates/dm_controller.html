<!DOCTYPE html>
<html>
<head>
    <title>Escape Room - DM Controller</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
            font-size: 2.5em;
            margin-bottom: 30px;
        }
        .panel {
            background: #0a0a0a;
            border: 2px solid #00ff00;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        .status-item {
            background: #000;
            padding: 15px;
            border: 1px solid #00ff00;
            border-radius: 5px;
        }
        .status-label {
            font-size: 0.9em;
            color: #888;
            margin-bottom: 5px;
        }
        .status-value {
            font-size: 1.5em;
            font-weight: bold;
        }
        .status-value.active {
            color: #ff0000;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        button {
            background: #003300;
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 15px 30px;
            font-size: 1.2em;
            cursor: pointer;
            margin: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }
        button:hover:not(:disabled) {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 20px #00ff00;
        }
        button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        button.danger {
            background: #330000;
            border-color: #ff0000;
            color: #ff0000;
        }
        button.danger:hover:not(:disabled) {
            background: #ff0000;
            color: #fff;
            box-shadow: 0 0 20px #ff0000;
        }
        button.warning {
            background: #332200;
            border-color: #ffaa00;
            color: #ffaa00;
        }
        button.warning:hover:not(:disabled) {
            background: #ffaa00;
            color: #000;
            box-shadow: 0 0 20px #ffaa00;
        }
        .button-group {
            text-align: center;
            margin: 20px 0;
        }
        .timer-display {
            font-size: 4em;
            text-align: center;
            color: #00ff00;
            text-shadow: 0 0 20px #00ff00;
            margin: 20px 0;
            font-weight: bold;
        }
        .timer-display.warning {
            color: #ffaa00;
            text-shadow: 0 0 20px #ffaa00;
        }
        .timer-display.critical {
            color: #ff0000;
            text-shadow: 0 0 20px #ff0000;
        }
        .audio-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .audio-btn {
            padding: 10px;
            font-size: 0.9em;
        }
        .log {
            background: #000;
            border: 1px solid #00ff00;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
            font-size: 0.9em;
            margin-top: 20px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #00ff00;
            padding-left: 10px;
        }
        .log-entry.error {
            border-left-color: #ff0000;
            color: #ff0000;
        }
        .log-entry.warning {
            border-left-color: #ffaa00;
            color: #ffaa00;
        }
        .log-entry.success {
            border-left-color: #00ff00;
            color: #00ff00;
        }
        .abort-status {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .abort-station {
            background: #000;
            border: 2px solid #666;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
        }
        .abort-station.pressed {
            border-color: #00ff00;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }
        .abort-station.pressed .status-circle {
            background: #00ff00;
            box-shadow: 0 0 20px #00ff00;
        }
        .status-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #333;
            margin: 10px auto;
            transition: all 0.3s;
        }
        h2 {
            color: #00ff00;
            margin-top: 0;
        }
        h3 {
            color: #00ff00;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ ESCAPE ROOM - DUNGEON MASTER CONTROL üéÆ</h1>
        
        <div class="panel">
            <h2>‚è±Ô∏è TIMER CONTROL</h2>
            <div class="timer-display" id="timerDisplay">30:00</div>
            <div class="button-group">
                <button id="startBtn" onclick="startTimer()">START GAME</button>
                <button id="pauseBtn" onclick="pauseTimer()" disabled>PAUSE</button>
                <button id="resumeBtn" onclick="resumeTimer()" disabled style="display:none;">RESUME</button>
                <button id="stopBtn" onclick="stopTimer()" class="danger" disabled>STOP & RESET</button>
                <button id="resetBtn" onclick="resetGame()" class="danger">RESET ALL</button>
            </div>
        </div>

        <div class="panel">
            <h2>üìä GAME STATUS</h2>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">Timer Status</div>
                    <div class="status-value" id="timerStatus">READY</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Reception Area</div>
                    <div class="status-value" id="receptionStatus">LOCKED</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Transmission</div>
                    <div class="status-value" id="transmissionStatus">ACTIVE</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Self-Destruct</div>
                    <div class="status-value" id="selfDestructStatus">STANDBY</div>
                </div>
            </div>
        </div>

        <div class="panel" id="abortPanel" style="display: none;">
            <h2>üö® ABORT SEQUENCE STATUS</h2>
            <div class="abort-status">
                <div class="abort-station" id="receptionAbort">
                    <h3>Reception Station</h3>
                    <div class="status-circle"></div>
                    <div id="receptionAbortStatus">Waiting...</div>
                </div>
                <div class="abort-station" id="serverAbort">
                    <h3>Server Room Station</h3>
                    <div class="status-circle"></div>
                    <div id="serverAbortStatus">Waiting...</div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>üîä AUDIO CONTROLS</h2>
            <div class="audio-controls">
                <button class="audio-btn" onclick="triggerAudio('alarm')">üö® Alarm</button>
                <button class="audio-btn" onclick="triggerAudio('creepy1')">üëª Creepy 1</button>
                <button class="audio-btn" onclick="triggerAudio('creepy2')">üëª Creepy 2</button>
                <button class="audio-btn" onclick="triggerAudio('footsteps')">üë£ Footsteps</button>
                <button class="audio-btn" onclick="triggerAudio('door_creak')">üö™ Door Creak</button>
                <button class="audio-btn" onclick="triggerAudio('whisper')">üíÄ Whisper</button>
            </div>
        </div>

        <div class="panel">
            <h2>üìú EVENT LOG</h2>
            <div class="log" id="eventLog"></div>
        </div>
    </div>

    <script>
        const socket = io('http://localhost:5000');
        let gameState = {
            timer_running: false,
            time_remaining: 1800,
            reception_unlocked: false,
            transmission_shut_down: false,
            self_destruct_active: false,
            self_destruct_aborted: false
        };

        socket.on('connect', () => {
            addLog('Connected to server', 'success');
        });

        socket.on('game_state', (state) => {
            gameState = state;
            updateDisplay();
        });

        socket.on('timer_started', (state) => {
            gameState = state;
            gameState.timer_running = true;
            addLog('Game started!', 'success');
            updateDisplay();
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('resumeBtn').style.display = 'none';
            document.getElementById('stopBtn').disabled = false;
        });

        socket.on('timer_update', (data) => {
            gameState.time_remaining = data.time_remaining;
            updateTimerDisplay();
        });

        socket.on('timer_paused', (state) => {
            gameState = state;
            addLog('Timer paused', 'warning');
            updateDisplay();
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('resumeBtn').disabled = false;
            document.getElementById('resumeBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').disabled = false;
        });

        socket.on('timer_resumed', (state) => {
            gameState = state;
            gameState.timer_running = true;
            addLog('Timer resumed', 'success');
            updateDisplay();
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('resumeBtn').disabled = true;
            document.getElementById('resumeBtn').style.display = 'none';
            document.getElementById('stopBtn').disabled = false;
        });

        socket.on('timer_stopped', (state) => {
            gameState = state;
            addLog('Timer stopped and reset', 'warning');
            updateDisplay();
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('resumeBtn').disabled = true;
            document.getElementById('resumeBtn').style.display = 'none';
            document.getElementById('stopBtn').disabled = true;
        });

        socket.on('game_reset', (state) => {
            gameState = state;
            addLog('Game reset', 'warning');
            updateDisplay();
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('resumeBtn').disabled = true;
            document.getElementById('resumeBtn').style.display = 'none';
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('abortPanel').style.display = 'none';
        });

        socket.on('transmission_shutdown', (data) => {
            if (data.success) {
                gameState.transmission_shut_down = true;
                gameState.self_destruct_active = true;
                addLog('‚ö†Ô∏è TRANSMISSION SHUT DOWN! SELF-DESTRUCT INITIATED!', 'error');
                document.getElementById('abortPanel').style.display = 'block';
                updateDisplay();
            }
        });

        socket.on('abort_button_pressed', (data) => {
            addLog(`Abort button pressed at ${data.location}. Waiting for ${data.waiting_for}...`, 'warning');
            if (data.location === 'reception') {
                document.getElementById('receptionAbort').classList.add('pressed');
                document.getElementById('receptionAbortStatus').textContent = 'PRESSED!';
            } else {
                document.getElementById('serverAbort').classList.add('pressed');
                document.getElementById('serverAbortStatus').textContent = 'PRESSED!';
            }
        });

        socket.on('abort_failed_warning', (data) => {
            addLog(`‚ö†Ô∏è Abort failed: Buttons pressed ${data.time_diff.toFixed(2)}s apart - SHOWING WARNING (8 seconds)`, 'error');
        });

        socket.on('abort_failed_full_reset', (data) => {
            addLog(`‚ùå Abort failed: FULL RESET TO CODE ENTRY`, 'error');
            document.getElementById('receptionAbort').classList.remove('pressed');
            document.getElementById('serverAbort').classList.remove('pressed');
            document.getElementById('receptionAbortStatus').textContent = 'Waiting...';
            document.getElementById('serverAbortStatus').textContent = 'Waiting...';
            
            // Hide abort panel and update game state display
            document.getElementById('abortPanel').style.display = 'none';
            gameState.self_destruct_active = false;
            gameState.transmission_shut_down = false;
            updateDisplay();
        });

        socket.on('self_destruct_aborted', (data) => {
            gameState.self_destruct_aborted = true;
            gameState.self_destruct_active = false;
            gameState.timer_running = false;
            addLog(`‚úÖ SELF-DESTRUCT ABORTED! Time difference: ${data.time_diff.toFixed(2)}s - PLAYERS WIN!`, 'success');
            updateDisplay();
        });

        socket.on('game_over', (data) => {
            gameState.timer_running = false;
            addLog('‚è∞ TIME\'S UP! Game over.', 'error');
            updateDisplay();
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('resumeBtn').disabled = true;
            document.getElementById('resumeBtn').style.display = 'none';
            document.getElementById('stopBtn').disabled = true;
        });

        function startTimer() {
            socket.emit('start_timer');
        }

        function pauseTimer() {
            if (confirm('Pause the timer? Players will be waiting.')) {
                socket.emit('pause_timer');
            }
        }

        function resumeTimer() {
            socket.emit('resume_timer');
        }

        function stopTimer() {
            if (confirm('Stop and reset the timer? This will end the current game and reset to 30:00.')) {
                socket.emit('stop_timer');
            }
        }

        function resetGame() {
            if (confirm('Are you sure you want to reset the entire game? This will reset all puzzles and the timer.')) {
                socket.emit('reset_game');
            }
        }

        function triggerAudio(clip) {
            socket.emit('trigger_audio', {clip: clip});
            addLog(`üîä Triggered audio: ${clip}`);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(gameState.time_remaining / 60);
            const seconds = gameState.time_remaining % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            const timerEl = document.getElementById('timerDisplay');
            timerEl.textContent = display;
            
            timerEl.classList.remove('warning', 'critical');
            if (gameState.time_remaining <= 300) timerEl.classList.add('warning');
            if (gameState.time_remaining <= 60) timerEl.classList.add('critical');
        }

        function updateDisplay() {
            updateTimerDisplay();
            
            // Timer Status
            const timerStatusEl = document.getElementById('timerStatus');
            if (gameState.timer_running) {
                timerStatusEl.textContent = 'RUNNING';
                timerStatusEl.style.color = '#00ff00';
            } else if (gameState.time_remaining < 1800 && gameState.time_remaining > 0) {
                timerStatusEl.textContent = 'PAUSED';
                timerStatusEl.style.color = '#ffaa00';
            } else {
                timerStatusEl.textContent = 'STOPPED';
                timerStatusEl.style.color = '#ff0000';
            }
            
            // Reception Status
            const receptionEl = document.getElementById('receptionStatus');
            if (gameState.reception_unlocked) {
                receptionEl.textContent = 'UNLOCKED';
                receptionEl.style.color = '#00ff00';
            } else {
                receptionEl.textContent = 'LOCKED';
                receptionEl.style.color = '#ff0000';
            }
            
            // Transmission Status
            const transmissionEl = document.getElementById('transmissionStatus');
            if (gameState.transmission_shut_down) {
                transmissionEl.textContent = 'SHUT DOWN';
                transmissionEl.style.color = '#ff0000';
            } else {
                transmissionEl.textContent = 'ACTIVE';
                transmissionEl.style.color = '#00ff00';
            }
            
            // Self-Destruct Status
            const sdEl = document.getElementById('selfDestructStatus');
            sdEl.classList.remove('active');
            if (gameState.self_destruct_aborted) {
                sdEl.textContent = 'ABORTED ‚úì';
                sdEl.style.color = '#00ff00';
            } else if (gameState.self_destruct_active) {
                sdEl.textContent = 'ACTIVE!';
                sdEl.style.color = '#ff0000';
                sdEl.classList.add('active');
            } else {
                sdEl.textContent = 'STANDBY';
                sdEl.style.color = '#ffaa00';
            }
        }

        function addLog(message, type = 'info') {
            const log = document.getElementById('eventLog');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        // Initial display update
        updateDisplay();
    </script>
</body>
</html>